'use client';

import React from 'react';
import { UserProfile } from '@/types';

interface StepProps {
    data: UserProfile;
    update: (section: keyof UserProfile, data: Record<string, unknown>) => void;
    onNext: () => void;
    onBack: () => void;
    canNext: boolean;
}

export default function FamilyVulnerabilityStep({ data, update, onNext, onBack, canNext }: StepProps) {
    const hasFrenchSpouse = data.family.spouse_nationality === 'FRENCH';
    const isNotSingle = data.family.spouse_nationality !== 'NONE';
    const showVulnerability = data.vulnerability.show_vulnerability;
    const isBornOrYoung = data.identity.born_in_france || (data.identity.age - data.timeline.years_continuous_residence) < 16;

    return (
        <div className="p-8 flex-1 flex flex-col">
            <h2 className="text-2xl font-bold text-slate-900 mb-1">Ã‰TAPE 4 : ATTACHES & VULNÃ‰RABILITÃ‰</h2>
            <p className="text-slate-500 mb-8">L'Ancrage : Voir vos droits liÃ©s Ã  votre vie privÃ©e, familiale et votre situation de santÃ©.</p>

            <div className="space-y-6 mb-8">
                {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                   Situation Matrimoniale (existant)
                   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
                <div>
                    <label className="block text-sm font-semibold text-slate-700 mb-4 tracking-wide uppercase text-indigo-900">
                        Situation Matrimoniale <span className="text-red-500">*</span>
                    </label>
                    <div className="flex gap-4">
                        <button
                            onClick={() => update('family', { spouse_nationality: data.family.spouse_nationality === 'NONE' ? 'NON_EU' : data.family.spouse_nationality })}
                            className={`flex-1 py-4 px-4 rounded-xl border-2 font-bold transition-all flex items-center justify-center gap-2 ${isNotSingle ? 'bg-indigo-600 text-white border-indigo-600 shadow-md ring-2 ring-indigo-200' : 'bg-white text-slate-500 border-slate-100 hover:border-slate-300'}`}
                        >
                            <span>ğŸ’</span> En couple (MariÃ©/PacsÃ©)
                        </button>
                        <button
                            onClick={() => update('family', { spouse_nationality: 'NONE', marriage_duration_years: 0, community_of_life: false })}
                            className={`flex-1 py-4 px-4 rounded-xl border-2 font-bold transition-all flex items-center justify-center gap-2 ${!isNotSingle ? 'bg-indigo-600 text-white border-indigo-600 shadow-md ring-2 ring-indigo-200' : 'bg-white text-slate-500 border-slate-100 hover:border-slate-300'}`}
                        >
                            <span>ğŸ‘¤</span> CÃ©libataire
                        </button>
                    </div>
                </div>

                {isNotSingle && (
                    <div className="space-y-6 animate-in fade-in slide-in-from-top-4 duration-300 p-6 bg-slate-50 rounded-2xl border border-slate-100">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">NationalitÃ© du conjoint(e)</label>
                                <select
                                    value={data.family.spouse_nationality}
                                    onChange={(e) => update('family', { spouse_nationality: e.target.value })}
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all bg-white"
                                >
                                    <option value="FRENCH">FranÃ§aise</option>
                                    <option value="EU">Union EuropÃ©enne</option>
                                    <option value="NON_EU">Autre (Hors UE)</option>
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">DurÃ©e (annÃ©es)</label>
                                <input
                                    type="number"
                                    value={data.family.marriage_duration_years}
                                    onChange={(e) => update('family', { marriage_duration_years: Number(e.target.value) || 0 })}
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                                />
                            </div>
                        </div>

                        <div className="flex items-center gap-3 p-4 bg-white rounded-xl border border-slate-200 shadow-sm">
                            <input
                                type="checkbox"
                                id="community_life"
                                checked={data.family.community_of_life}
                                onChange={(e) => update('family', { community_of_life: e.target.checked })}
                                className="w-5 h-5 text-indigo-600 rounded"
                            />
                            <label htmlFor="community_life" className="text-sm font-medium text-slate-700">
                                CommunautÃ© de vie effective (vie commune)
                            </label>
                        </div>

                        {hasFrenchSpouse && (
                            <div className="flex items-center gap-3 p-4 bg-blue-50 rounded-xl border border-blue-100 animate-in fade-in slide-in-from-top-2 duration-300">
                                <input
                                    type="checkbox"
                                    id="spouse_kept_nationality"
                                    checked={data.family.spouse_kept_nationality ?? true}
                                    onChange={(e) => update('family', { spouse_kept_nationality: e.target.checked })}
                                    className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
                                />
                                <label htmlFor="spouse_kept_nationality" className="text-sm font-semibold text-blue-900 cursor-pointer select-none">
                                    Votre conjoint(e) a conservÃ© la nationalitÃ© franÃ§aise
                                </label>
                            </div>
                        )}

                        {/* DurÃ©e de cohabitation (pour les pacsÃ©s) */}
                        {data.family.is_pacsed_with_french && (
                            <div className="animate-in fade-in slide-in-from-top-2 duration-300">
                                <label className="block text-sm font-medium text-gray-700 mb-1">DurÃ©e de cohabitation (annÃ©es)</label>
                                <input
                                    type="number"
                                    value={data.family.cohabitation_duration_years || 0}
                                    onChange={(e) => update('family', { cohabitation_duration_years: Number(e.target.value) || 0 })}
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                                />
                            </div>
                        )}

                        {/* Conjoint avec Passeport Talent */}
                        {!hasFrenchSpouse && (
                            <div className="flex items-center gap-3 p-4 bg-violet-50 rounded-xl border border-violet-100 animate-in fade-in slide-in-from-top-2 duration-300">
                                <input
                                    type="checkbox"
                                    id="spouse_passport_talent"
                                    checked={data.family.spouse_has_passport_talent || false}
                                    onChange={(e) => update('family', { spouse_has_passport_talent: e.target.checked })}
                                    className="w-5 h-5 text-violet-600 rounded focus:ring-violet-500"
                                />
                                <label htmlFor="spouse_passport_talent" className="text-sm font-semibold text-violet-900 cursor-pointer select-none">
                                    Mon conjoint(e) est titulaire d'un Passeport Talent
                                </label>
                            </div>
                        )}
                    </div>
                )}

                {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                   Enfants & Q2 â€” Liens familiaux avec la France
                   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
                <div className="space-y-4">
                    <label className="block text-sm font-semibold text-slate-700 mb-2 tracking-wide uppercase text-indigo-900">Liens familiaux & Enfants</label>
                    <div className="grid grid-cols-1 gap-4">
                        <div className={`p-4 rounded-xl border-2 transition-all ${data.family.has_french_child ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100'}`}>
                            <div className="flex items-center gap-3">
                                <input
                                    type="checkbox"
                                    id="has_children"
                                    checked={data.family.has_french_child}
                                    onChange={(e) => update('family', { has_french_child: e.target.checked })}
                                    className="w-5 h-5 text-indigo-600 rounded"
                                />
                                <label htmlFor="has_children" className="text-sm font-bold text-slate-800">
                                    J'ai au moins un enfant franÃ§ais mineur
                                </label>
                            </div>
                        </div>

                        {data.family.has_french_child && (
                            <div className="ml-4 space-y-3 animate-in fade-in slide-in-from-top-2 duration-300">
                                <div className={`p-4 rounded-xl border-2 transition-all ${data.family.contributes_to_education ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-100'}`}>
                                    <div className="flex items-center gap-3">
                                        <input
                                            type="checkbox"
                                            id="contributes_to_education"
                                            checked={data.family.contributes_to_education ?? true}
                                            onChange={(e) => update('family', { contributes_to_education: e.target.checked })}
                                            className="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500"
                                        />
                                        <label htmlFor="contributes_to_education" className="text-sm font-semibold text-emerald-900 cursor-pointer select-none">
                                            Je contribue Ã  son Ã©ducation et entretien
                                        </label>
                                    </div>
                                </div>

                                <div className="flex items-center gap-3 p-4 bg-blue-50 rounded-xl border border-blue-100">
                                    <input
                                        type="checkbox"
                                        id="child_residence"
                                        checked={data.family.child_residence_france ?? true}
                                        onChange={(e) => update('family', { child_residence_france: e.target.checked })}
                                        className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
                                    />
                                    <label htmlFor="child_residence" className="text-sm font-semibold text-blue-900 cursor-pointer select-none">
                                        Mon enfant rÃ©side en France
                                    </label>
                                </div>
                            </div>
                        )}

                        {/* Q2 â€” Liens familiaux supplÃ©mentaires (si pas mariÃ© Ã  un FranÃ§ais) */}
                        {!hasFrenchSpouse && (
                            <div className="p-5 bg-sky-50 rounded-2xl border border-sky-100 animate-in fade-in slide-in-from-top-4 duration-300">
                                <h4 className="text-xs font-bold text-sky-800 uppercase tracking-widest mb-3">ğŸ”— Autres liens familiaux avec la France</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div className="flex items-center gap-3 p-3 bg-white rounded-xl border border-sky-200">
                                        <input
                                            type="checkbox"
                                            id="is_pacsed"
                                            checked={data.family.is_pacsed_with_french || false}
                                            onChange={(e) => update('family', { is_pacsed_with_french: e.target.checked })}
                                            className="w-4 h-4 text-sky-600 rounded focus:ring-sky-500"
                                        />
                                        <label htmlFor="is_pacsed" className="text-xs font-semibold text-sky-900 cursor-pointer select-none">
                                            PacsÃ©(e) avec un(e) FranÃ§ais(e)
                                        </label>
                                    </div>

                                    <div className="flex items-center gap-3 p-3 bg-white rounded-xl border border-sky-200">
                                        <input
                                            type="checkbox"
                                            id="has_french_sibling"
                                            checked={data.family.has_french_sibling || false}
                                            onChange={(e) => update('family', { has_french_sibling: e.target.checked })}
                                            className="w-4 h-4 text-sky-600 rounded focus:ring-sky-500"
                                        />
                                        <label htmlFor="has_french_sibling" className="text-xs font-semibold text-sky-900 cursor-pointer select-none">
                                            FrÃ¨re ou sÅ“ur de nationalitÃ© franÃ§aise
                                        </label>
                                    </div>

                                    <div className="flex items-center gap-3 p-3 bg-white rounded-xl border border-sky-200">
                                        <input
                                            type="checkbox"
                                            id="is_ascendant"
                                            checked={data.family.is_ascendant_of_french || false}
                                            onChange={(e) => update('family', { is_ascendant: e.target.checked, is_ascendant_of_french: e.target.checked })}
                                            className="w-4 h-4 text-sky-600 rounded focus:ring-sky-500"
                                        />
                                        <label htmlFor="is_ascendant" className="text-xs font-semibold text-sky-900 cursor-pointer select-none">
                                            Parent/Ascendant d'un FranÃ§ais majeur
                                        </label>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                           Q3 â€” SantÃ© & VulnÃ©rabilitÃ© (toggle + dÃ©tails)
                           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
                        <div className={`p-4 rounded-xl border-2 transition-all ${showVulnerability ? 'bg-rose-50 border-rose-100' : 'bg-white border-slate-100'}`}>
                            <div className="flex items-center gap-3">
                                <input
                                    type="checkbox"
                                    id="vulnerability"
                                    checked={showVulnerability}
                                    onChange={(e) => update('vulnerability', { show_vulnerability: e.target.checked })}
                                    className="w-5 h-5 text-rose-500 rounded"
                                />
                                <label htmlFor="vulnerability" className="text-sm font-bold text-slate-800">
                                    Je suis concernÃ©(e) par une situation de santÃ© ou de violence
                                </label>
                            </div>
                        </div>

                        {showVulnerability && (
                            <div className="ml-4 p-5 bg-rose-50 rounded-2xl border border-rose-100 animate-in fade-in slide-in-from-top-4 duration-300">
                                <h4 className="text-xs font-bold text-rose-800 uppercase tracking-widest mb-3">ğŸ©º PrÃ©cisez votre situation</h4>
                                <div className="space-y-3">
                                    <div className="flex items-center gap-3 p-3 bg-white rounded-xl border border-rose-200">
                                        <input
                                            type="checkbox"
                                            id="personal_treatment"
                                            checked={data.health?.personal_needs_treatment || false}
                                            onChange={(e) => update('health', {
                                                personal_needs_treatment: e.target.checked,
                                                ...(e.target.checked ? {} : { treatment_unavailable_in_origin: false, treatment_available_origin: true })
                                            })}
                                            className="w-4 h-4 text-rose-600 rounded focus:ring-rose-500"
                                        />
                                        <label htmlFor="personal_treatment" className="text-xs font-semibold text-rose-900 cursor-pointer select-none">
                                            J'ai besoin de soins mÃ©dicaux indisponibles dans mon pays
                                        </label>
                                    </div>

                                    {data.health?.personal_needs_treatment && (
                                        <div className="ml-6 flex items-center gap-3 p-3 bg-white rounded-xl border border-rose-200 animate-in fade-in slide-in-from-top-2 duration-200">
                                            <input
                                                type="checkbox"
                                                id="treatment_unavailable"
                                                checked={data.health?.treatment_unavailable_in_origin ?? true}
                                                onChange={(e) => update('health', {
                                                    treatment_unavailable_in_origin: e.target.checked,
                                                    treatment_available_origin: !e.target.checked
                                                })}
                                                className="w-4 h-4 text-rose-600 rounded focus:ring-rose-500"
                                            />
                                            <label htmlFor="treatment_unavailable" className="text-xs font-semibold text-rose-900 cursor-pointer select-none">
                                                Ce traitement n'est effectivement pas disponible dans mon pays d'origine
                                            </label>
                                        </div>
                                    )}

                                    <div className="flex items-center gap-3 p-3 bg-white rounded-xl border border-rose-200">
                                        <input
                                            type="checkbox"
                                            id="child_care"
                                            checked={data.health?.child_needs_care || false}
                                            onChange={(e) => update('health', { child_needs_care: e.target.checked })}
                                            className="w-4 h-4 text-rose-600 rounded focus:ring-rose-500"
                                        />
                                        <label htmlFor="child_care" className="text-xs font-semibold text-rose-900 cursor-pointer select-none">
                                            Mon enfant nÃ©cessite des soins mÃ©dicaux en France
                                        </label>
                                    </div>

                                    <div className="flex items-center gap-3 p-3 bg-white rounded-xl border border-rose-200">
                                        <input
                                            type="checkbox"
                                            id="work_accident"
                                            checked={data.work?.has_work_accident_pension || false}
                                            onChange={(e) => update('work', { has_work_accident_pension: e.target.checked })}
                                            className="w-4 h-4 text-rose-600 rounded focus:ring-rose-500"
                                        />
                                        <label htmlFor="work_accident" className="text-xs font-semibold text-rose-900 cursor-pointer select-none">
                                            Je perÃ§ois une rente d'accident du travail (taux â‰¥ 20%)
                                        </label>
                                    </div>

                                    <div className="flex items-center gap-3 p-3 bg-white rounded-xl border border-rose-200">
                                        <input
                                            type="checkbox"
                                            id="victim_trafficking"
                                            checked={data.vulnerability?.is_victim_trafficking || false}
                                            onChange={(e) => update('vulnerability', { is_victim_trafficking: e.target.checked })}
                                            className="w-4 h-4 text-rose-600 rounded focus:ring-rose-500"
                                        />
                                        <label htmlFor="victim_trafficking" className="text-xs font-semibold text-rose-900 cursor-pointer select-none">
                                            Victime de traite des Ãªtres humains
                                        </label>
                                    </div>

                                    <div className="flex items-center gap-3 p-3 bg-white rounded-xl border border-rose-200">
                                        <input
                                            type="checkbox"
                                            id="victim_violence"
                                            checked={data.vulnerability?.is_victim_domestic_violence || false}
                                            onChange={(e) => update('vulnerability', {
                                                is_victim_domestic_violence: e.target.checked,
                                                has_protection_order_violence: e.target.checked
                                            })}
                                            className="w-4 h-4 text-rose-600 rounded focus:ring-rose-500"
                                        />
                                        <label htmlFor="victim_violence" className="text-xs font-semibold text-rose-900 cursor-pointer select-none">
                                            Victime de violences conjugales / ordonnance de protection
                                        </label>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>

                {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                   Q4 â€” Parcours scolaire en France
                   (nÃ© en France ou arrivÃ© jeune)
                   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
                {isBornOrYoung && (
                    <div className="p-5 bg-teal-50 rounded-2xl border border-teal-100 animate-in fade-in slide-in-from-top-4 duration-300">
                        <h4 className="text-xs font-bold text-teal-800 uppercase tracking-widest mb-3">ğŸ“ Parcours scolaire en France</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">AnnÃ©es de scolaritÃ© en France</label>
                                <input
                                    type="number"
                                    value={data.education?.years_schooling_france || 0}
                                    onFocus={(e) => e.target.select()}
                                    onChange={(e) => {
                                        const val = Number(e.target.value) || 0;
                                        update('education', {
                                            years_schooling_france: val,
                                            schooling_in_france_age_6_to_16: val >= 5
                                        });
                                    }}
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition-all"
                                />
                            </div>

                            <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">AnnÃ©es d'Ã©tudes supÃ©rieures en France</label>
                                <input
                                    type="number"
                                    value={data.education?.years_higher_education || 0}
                                    onFocus={(e) => e.target.select()}
                                    onChange={(e) => update('education', { years_higher_education: Number(e.target.value) || 0 })}
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition-all"
                                />
                            </div>
                        </div>
                    </div>
                )}
            </div>

            <div className="mt-auto flex justify-between">
                <button
                    onClick={onBack}
                    className="px-6 py-3 text-gray-500 hover:text-gray-700 hover:bg-gray-100 font-semibold rounded-lg transition-all duration-200"
                >
                    PrÃ©cÃ©dent
                </button>
                <button
                    onClick={onNext}
                    disabled={!canNext}
                    className={`w-full md:w-auto px-8 py-3 font-semibold rounded-lg transition-all duration-200 ${canNext
                        ? 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-200'
                        : 'bg-slate-200 text-slate-400 cursor-not-allowed'
                        }`}
                >
                    Voir les RÃ©sultats
                </button>
            </div>
        </div>
    );
}
