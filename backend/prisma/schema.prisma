generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Prospect {
  id                String         @id @default(cuid())
  firstName         String
  lastName          String
  phone             String
  email             String?
  source            String         @default("MANUAL")
  campaignName      String?
  interestServiceId String?
  score             Int            @default(0)
  agencyId          String
  assignedToSalesId String?
  status            ProspectStatus @default(TO_CALL)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  lastContactAt     DateTime?
  callLogs          CallLog[]
  notes             ProspectNote[]
  communications    Communication[]
}

model CallLog {
  id            String    @id @default(cuid())
  prospectId    String
  userId        String
  direction     String    @default("OUTBOUND")
  status        String    @default("INITIATED")
  duration      Int       @default(0)
  twilioCallSid String?
  startedAt     DateTime  @default(now())
  endedAt       DateTime?
  notes         String?
  prospect      Prospect  @relation(fields: [prospectId], references: [id])
}

model ProspectNote {
  id         String   @id @default(cuid())
  text       String
  authorId   String
  prospectId String
  createdAt  DateTime @default(now())
  prospect   Prospect @relation(fields: [prospectId], references: [id])
}

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  password       String
  name           String
  role           UserRole      @default(KIOSK_AGENT)
  roleId         String?
  agencyId       String?
  homeAgencyId   String?
  scopeAgencyIds String        @default("[]")
  permissions    String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  lastLogin      DateTime?
  isSystemUser   Boolean       @default(false)
  expertises     String        @default("[]")
  absences       Absence[]
  appointments   Appointment[]
  leads          Lead[]
  agency         Agency?       @relation(fields: [agencyId], references: [id])
  roleRef        Role?         @relation(fields: [roleId], references: [id])
}

model Absence {
  id        String   @id @default(cuid())
  userId    String
  start     DateTime
  end       DateTime
  reason    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
}

model Role {
  id          String   @id @default(cuid())
  label       String
  description String
  permissions String
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
}

model Agency {
  id                         String         @id
  name                       String
  type                       AgencyType
  status                     AgencyStatus   @default(ACTIVE)
  region                     String         @default("IDF")
  city                       String         @default("Paris")
  zipCodes                   String
  commissionRate             Float          @default(15)
  serviceCommissionOverrides String?
  contactEmail               String
  iban                       String?
  bic                        String?
  kioskUrl                   String
  createdAt                  DateTime       @default(now())
  updatedAt                  DateTime       @updatedAt
  appointments               Appointment[]
  devices                    Device[]
  franchiseOrigin            FranchiseLead?
  leads                      Lead[]
  payouts                    Payout[]
  users                      User[]
}

model Lead {
  id             String        @id
  name           String
  email          String
  phone          String
  serviceId      String
  serviceName    String
  amountPaid     Int           @default(0)
  paymentMethod  String?       @default("UNPAID")
  paymentDate    DateTime?
  paymentRef     String?
  invoiceNumber  String?
  status         LeadStatus    @default(NEW)
  originAgencyId String?
  contract       String?
  documents      String        @default("[]")
  requiredDocs   String?
  assignedUserId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  data           String        @default("{}")
  appointments   Appointment[]
  creditNotes    CreditNote[]
  assignedUser   User?         @relation(fields: [assignedUserId], references: [id])
  originAgency   Agency?       @relation(fields: [originAgencyId], references: [id])
  notes          LeadNote[]
  transactions   Transaction[]
  communications Communication[]
}

model LeadNote {
  id        String   @id @default(cuid())
  content   String
  author    String
  leadId    String
  createdAt DateTime @default(now())
  lead      Lead     @relation(fields: [leadId], references: [id])
}

model Payout {
  id        String    @id @default(cuid())
  agencyId  String
  amount    Float
  period    String
  status    String    @default("PAID")
  paidAt    DateTime? @default(now())
  reference String    @default("VIR-SIMULEGAL")
  createdAt DateTime  @default(now())
  agency    Agency    @relation(fields: [agencyId], references: [id])
}

model Device {
  id               String   @id @default(cuid())
  pairingCode      String   @unique
  status           String   @default("UNPAIRED")
  name             String   @default("Nouveau Terminal")
  assignedAgencyId String?
  appVersion       String   @default("1.0.0")
  lastHeartbeat    DateTime @default(now())
  createdAt        DateTime @default(now())
  assignedAgency   Agency?  @relation(fields: [assignedAgencyId], references: [id])
}

model FranchiseLead {
  id                String              @id @default(cuid())
  name              String
  email             String              @unique
  phone             String
  targetCity        String
  region            String              @default("IDF")
  status            FranchiseLeadStatus @default(NEW)
  companyName       String?
  siret             String?
  legalForm         String?
  contractDetails   String              @default("{}")
  contractHistory   String              @default("[]")
  documents         String              @default("[]")
  convertedAgencyId String?             @unique
  rejectionReason   String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  convertedAgency   Agency?             @relation(fields: [convertedAgencyId], references: [id])
  notes             FranchiseLeadNote[]
}

model FranchiseLeadNote {
  id        String        @id @default(cuid())
  content   String
  type      String        @default("NOTE")
  author    String
  leadId    String
  createdAt DateTime      @default(now())
  lead      FranchiseLead @relation(fields: [leadId], references: [id])
}

model Appointment {
  id                 String            @id @default(cuid())
  start              DateTime
  end                DateTime
  type               AppointmentType
  status             AppointmentStatus @default(SCHEDULED)
  leadId             String
  leadName           String
  leadEmail          String?
  agencyId           String?
  hostUserId         String?
  meetingLink        String?
  serviceId          String?
  cancellationReason String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  agency             Agency?           @relation(fields: [agencyId], references: [id])
  hostUser           User?             @relation(fields: [hostUserId], references: [id])
  lead               Lead              @relation(fields: [leadId], references: [id])
}

model SystemSettings {
  id            String   @id @default("GLOBAL")
  company       String   @default("{}")
  payment       String   @default("{}")
  notifications String   @default("{}")
  integrations  String   @default("{}")
  storage       String   @default("{}")
  updatedAt     DateTime @updatedAt
}

model Transaction {
  id            String   @id @default(cuid())
  type          String   @default("PAYMENT")
  amount        Int
  method        String?
  reference     String?
  leadId        String
  invoiceNumber String?
  createdAt     DateTime @default(now())
  lead          Lead     @relation(fields: [leadId], references: [id])
}

model CreditNote {
  id        String   @id @default(cuid())
  number    String   @unique
  amount    Int
  reason    String
  leadId    String
  createdAt DateTime @default(now())
  lead      Lead     @relation(fields: [leadId], references: [id])
}

enum UserRole {
  SUPER_ADMIN
  HQ_ADMIN
  CASE_WORKER
  AGENCY_MANAGER
  SALES
  KIOSK_AGENT
  API_PARTNER
}

enum AgencyType {
  OWNED
  FRANCHISE
  CORNER
  HQ
  PHYSICAL
}

enum AgencyStatus {
  ACTIVE
  INACTIVE
}

enum LeadStatus {
  NEW
  COLLECTING
  REVIEW
  HUNTING
  BOOKED
  ANTS_SUBMISSION
  WAITING_ORIGINAL
  DRAFTING
  SUBMITTED
  OFII_INVESTIGATION
  DECISION_WAIT
  INSTRUCTION
  TO_CONTACT
  QUALIFIED
  SCHEDULING
  DONE
  ARCHIVED
  CLOSED
  LEAD
  CONTACTED
  SIGNED
  PAID
  PROCESSING
  COMPLETED
  CANCELLED
}

enum ProspectStatus {
  TO_CALL
  IN_DISCUSSION
  MEETING_BOOKED
  LINK_SENT
  CONVERTED
  LOST
}

enum FranchiseLeadStatus {
  NEW
  CONTACTED
  MEETING
  VALIDATED
  CONTRACT_SENT
  SIGNED
  REJECTED
}

enum AppointmentType {
  VISIO_JURISTE
  PHYSICAL_AGENCY
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Communication {
  id          String   @id @default(cuid())
  direction   String   // INBOUND or OUTBOUND
  type        String   @default("WHATSAPP") // WHATSAPP, SMS, EMAIL
  content     String
  sender      String   // Phone number or User ID or "SYSTEM"
  senderName  String?
  leadId      String?
  prospectId  String?
  createdAt   DateTime @default(now())
  
  lead        Lead?     @relation(fields: [leadId], references: [id])
  prospect    Prospect? @relation(fields: [prospectId], references: [id])
}

// ─── Veille Juridique ──────────────────────────────────────────────

model LegalUpdate {
  id         String   @id @default(cuid())
  title      String
  summary    String
  category   String
  severity   String   @default("medium") // high | medium | low
  sourceUrl  String?
  authorName String?
  applied    Boolean  @default(false)
  appliedAt  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// ─── Audit Trail des Règles ────────────────────────────────────────

model RuleAuditLog {
  id             String   @id @default(cuid())
  category       String   // sejour | naturalisation | family
  ruleId         String   // id de la règle modifiée
  ruleName       String   // nom lisible de la règle
  action         String   // CREATE | UPDATE | DELETE
  changedBy      String   // nom ou email du juriste
  previousValue  String?  // JSON snapshot avant modification
  newValue       String?  // JSON snapshot après modification  
  changeDetails  String?  // description textuelle du changement
  createdAt      DateTime @default(now())
}
