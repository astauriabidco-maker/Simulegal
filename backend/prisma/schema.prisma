// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  SUPER_ADMIN
  HQ_ADMIN
  CASE_WORKER
  AGENCY_MANAGER
  SALES
  KIOSK_AGENT
}

enum AgencyType {
  OWNED      // Agence Intégrée
  FRANCHISE  // Partenaire indépendant
  CORNER     // Point relais / Borne
  HQ         // Siège
  PHYSICAL   // Legacy
}

enum AgencyStatus {
  ACTIVE
  INACTIVE
}

enum LeadStatus {
  NEW
  COLLECTING
  REVIEW
  HUNTING
  BOOKED
  ANTS_SUBMISSION
  WAITING_ORIGINAL
  DRAFTING
  SUBMITTED
  OFII_INVESTIGATION
  DECISION_WAIT
  INSTRUCTION
  TO_CONTACT
  QUALIFIED
  SCHEDULING
  DONE
  ARCHIVED
  CLOSED
  // Legacy
  LEAD
  CONTACTED
  SIGNED
  PAID
  PROCESSING
  COMPLETED
  CANCELLED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole  @default(KIOSK_AGENT)
  roleId        String?
  roleRef       Role?     @relation(fields: [roleId], references: [id])
  agencyId      String?   // @deprecated: utilise homeAgencyId à la place
  agency        Agency?   @relation(fields: [agencyId], references: [id])
  
  // Scoping & Rattachement
  homeAgencyId  String?   // Rattachement physique (null = HQ)
  scopeAgencyIds String   @default("[]") // Périmètre de supervision (JSON stringé: string[])
  permissions   String    // À migrer vers Role.permissions
  appointments  Appointment[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLogin     DateTime?
}

model Role {
  id          String   @id @default(cuid())
  label       String
  description String
  permissions String   // Stocké sous forme de chaîne (ex: "crm.view_all,finance.view_global")
  isSystem    Boolean  @default(false)
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Agency {
  id             String       @id
  name           String
  type           AgencyType
  status         AgencyStatus @default(ACTIVE)
  region         String       @default("IDF") // Région (ex: IDF, PACA, AURA)
  zipCodes       String       // Stocké sous forme de chaîne (ex: "75001,75002")
  commissionRate Float        @default(15)
  contactEmail   String
  kioskUrl       String
  users          User[]
  appointments   Appointment[]
  leads          Lead[]
  payouts        Payout[]
  devices        Device[]
  franchiseOrigin FranchiseLead? // Relation inverse : le lead qui a donné naissance à cette agence
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Lead {
  id             String     @id
  name           String
  email          String
  phone          String
  serviceId      String
  serviceName    String
  amountPaid     Int        @default(0)
  status         LeadStatus @default(NEW)
  originAgencyId String?
  originAgency   Agency?    @relation(fields: [originAgencyId], references: [id])
  
  // Nouveaux champs pour la persistence complète
  contract       String?    // Stocké en JSON stringé pour SQLite
  documents      String     @default("[]") // Liste des documents (JSON stringé)
  requiredDocs   String?    // Checklist personnalisée (JSON stringé)
  
  notes          LeadNote[]
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model LeadNote {
  id        String   @id @default(cuid())
  content   String
  author    String
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id])
  createdAt DateTime @default(now())
}

model Payout {
  id        String   @id @default(cuid())
  agencyId  String
  agency    Agency   @relation(fields: [agencyId], references: [id])
  amount    Float
  period    String
  status    String   @default("PAID")
  paidAt    DateTime? @default(now())
  reference String   @default("VIR-SIMULEGAL")
  createdAt DateTime @default(now())
}

model Device {
  id               String   @id @default(cuid())
  pairingCode      String   @unique
  status           String   @default("UNPAIRED") // UNPAIRED, ACTIVE, OFFLINE
  name             String   @default("Nouveau Terminal")
  assignedAgencyId String?
  assignedAgency   Agency?  @relation(fields: [assignedAgencyId], references: [id])
  appVersion       String   @default("1.0.0")
  lastHeartbeat    DateTime @default(now())
  createdAt        DateTime @default(now())
}

enum FranchiseLeadStatus {
  NEW
  CONTACTED
  MEETING
  VALIDATED
  CONTRACT_SENT
  SIGNED
  REJECTED
}

model FranchiseLead {
  id              String              @id @default(cuid())
  name            String
  email           String              @unique
  phone           String
  targetCity      String
  region          String              @default("IDF")
  
  status          FranchiseLeadStatus @default(NEW)
  
  // Personne Morale
  companyName     String?             // Raison Sociale
  siret           String?
  legalForm       String?             // SAS, SARL, etc.
  
  // Détails du futur contrat (JSON)
  contractDetails String              @default("{}") // { commissionRate, type: 'CORNER'|'FRANCHISE', ... }
  
  // Lien vers l'agence une fois convertie
  convertedAgencyId String?             @unique
  convertedAgency   Agency?           @relation(fields: [convertedAgencyId], references: [id])
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  notes           FranchiseLeadNote[]
}

model FranchiseLeadNote {
  id              String        @id @default(cuid())
  content         String
  type            String        @default("NOTE") // NOTE, CALL, EMAIL
  author          String
  leadId          String
  lead            FranchiseLead @relation(fields: [leadId], references: [id])
  createdAt       DateTime      @default(now())
}

model Appointment {
  id          String           @id @default(cuid())
  start       DateTime
  end         DateTime
  type        AppointmentType
  status      AppointmentStatus @default(SCHEDULED)
  
  // Client Info (denormalized)
  leadId      String
  leadName    String
  leadEmail   String?

  // Context
  agencyId    String?
  agency      Agency?          @relation(fields: [agencyId], references: [id])
  
  hostUserId  String?
  hostUser    User?            @relation(fields: [hostUserId], references: [id])

  meetingLink String?

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

enum AppointmentType {
  VISIO_JURISTE
  PHYSICAL_AGENCY
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}
