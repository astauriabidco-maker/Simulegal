generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Prospect {
  id                String         @id @default(cuid())
  firstName         String
  lastName          String
  phone             String
  email             String?

  // Adresse — remplie progressivement lors de la qualification
  address           String?        // Numéro + rue
  city              String?
  zipCode           String?        // Code postal — sert au routage agence
  country           String?        @default("France")

  source            String         @default("MANUAL")
  campaignName      String?
  interestServiceId String?
  score             Int            @default(0)
  agencyId          String
  assignedToSalesId String?
  status            ProspectStatus @default(NEW)
  convertedLeadId   String?        // Lien vers le Lead CRM après signature
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  lastContactAt     DateTime?

  // ── Suivi des tentatives d'appel ──
  callAttempts         Int       @default(0)
  noAnswerCount        Int       @default(0)
  callbackCount        Int       @default(0)
  callbackRequestedAt  DateTime?
  callbackScheduledAt  DateTime?    // Date+heure du prochain rappel programmé
  lastCallOutcome      String?

  // ── Pipeline tracking ──
  noShowCount          Int       @default(0)  // Nombre de RDV non honorés
  qualifiedAt          DateTime?              // Date de qualification
  stageEnteredAt       DateTime? @default(now()) // Date d'entrée dans l'étape actuelle
  lostReason           String?                // Raison de la perte
  tags                 String?                // JSON array de tags ex: ["VIP","Urgent","Diaspora"]

  // ── Rendez-vous ──
  appointment          Json?        // Données de RDV (date, agence, etc.)

  // ── Résultat de simulation d'éligibilité ──
  eligibilityResult    Json?        // Résultat complet du simulateur (isEligible, score, matchedProcedures, etc.)

  callLogs             CallLog[]
  notes                ProspectNote[]
  communications       Communication[]
  appointments         SalesAppointment[]
  calendarAppointments Appointment[]
}

// ── Rendez-vous commercial en agence ──
model SalesAppointment {
  id              String    @id @default(cuid())
  prospectId      String
  prospect        Prospect  @relation(fields: [prospectId], references: [id])
  
  date            DateTime
  agencyId        String
  agencyName      String
  serviceId       String?
  
  status          String    @default("SCHEDULED")  // SCHEDULED, CONFIRMED, COMPLETED, NO_SHOW, CANCELLED
  meetingLink     String?
  
  confirmationSent    Boolean   @default(false)
  confirmationSentVia String?   // SMS, WHATSAPP
  
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model CallLog {
  id            String    @id @default(cuid())
  prospectId    String
  userId        String
  direction     String    @default("OUTBOUND")
  status        String    @default("INITIATED")
  duration      Int       @default(0)
  twilioCallSid String?
  startedAt     DateTime  @default(now())
  endedAt       DateTime?
  notes         String?
  prospect      Prospect  @relation(fields: [prospectId], references: [id])
}

model ProspectNote {
  id         String   @id @default(cuid())
  text       String
  authorId   String
  prospectId String
  createdAt  DateTime @default(now())
  prospect   Prospect @relation(fields: [prospectId], references: [id])
}

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  password       String
  name           String
  role           UserRole      @default(KIOSK_AGENT)
  roleId         String?
  agencyId       String?
  homeAgencyId   String?
  scopeAgencyIds String        @default("[]")
  permissions    String
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  lastLogin      DateTime?
  isSystemUser   Boolean       @default(false)
  expertises     String        @default("[]")
  absences       Absence[]
  appointments   Appointment[]
  slots          AppointmentSlot[]
  leads          Lead[]
  agency         Agency?       @relation(fields: [agencyId], references: [id])
  roleRef        Role?         @relation(fields: [roleId], references: [id])
}

model Absence {
  id        String   @id @default(cuid())
  userId    String
  start     DateTime
  end       DateTime
  reason    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
}

model Role {
  id          String   @id @default(cuid())
  label       String
  description String
  permissions String
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
}

model Agency {
  id                         String         @id
  name                       String
  type                       AgencyType
  status                     AgencyStatus   @default(ACTIVE)
  region                     String         @default("IDF")
  city                       String         @default("Paris")
  zipCodes                   String
  commissionRate             Float          @default(15)
  serviceCommissionOverrides String?
  contactEmail               String
  iban                       String?
  bic                        String?
  kioskUrl                   String
  createdAt                  DateTime       @default(now())
  updatedAt                  DateTime       @updatedAt
  appointments               Appointment[]
  devices                    Device[]
  franchiseOrigin            FranchiseLead?
  leads                      Lead[]
  payouts                    Payout[]
  users                      User[]
}

model Lead {
  id             String        @id
  name           String
  email          String
  phone          String
  serviceId      String
  serviceName    String
  amountPaid     Int           @default(0)
  paymentMethod  String?       @default("UNPAID")
  paymentDate    DateTime?
  paymentRef     String?
  invoiceNumber  String?
  status         LeadStatus    @default(NEW)
  originAgencyId String?
  contract       String?
  documents      String        @default("[]")
  requiredDocs   String?
  assignedUserId String?
  stageEnteredAt DateTime      @default(now())
  stageHistory   String        @default("[]")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  data           String        @default("{}")
  slots          AppointmentSlot[]
  appointments   Appointment[]
  creditNotes    CreditNote[]
  assignedUser   User?         @relation(fields: [assignedUserId], references: [id])
  originAgency   Agency?       @relation(fields: [originAgencyId], references: [id])
  notes          LeadNote[]
  transactions   Transaction[]
  communications Communication[]
}

model LeadNote {
  id        String   @id @default(cuid())
  content   String
  author    String
  leadId    String
  createdAt DateTime @default(now())
  lead      Lead     @relation(fields: [leadId], references: [id])
}

model Payout {
  id        String    @id @default(cuid())
  agencyId  String
  amount    Float
  period    String
  status    String    @default("PAID")
  paidAt    DateTime? @default(now())
  reference String    @default("VIR-SIMULEGAL")
  createdAt DateTime  @default(now())
  agency    Agency    @relation(fields: [agencyId], references: [id])
}

model Device {
  id               String   @id @default(cuid())
  pairingCode      String   @unique
  status           String   @default("UNPAIRED")
  name             String   @default("Nouveau Terminal")
  assignedAgencyId String?
  appVersion       String   @default("1.0.0")
  lastHeartbeat    DateTime @default(now())
  createdAt        DateTime @default(now())
  assignedAgency   Agency?  @relation(fields: [assignedAgencyId], references: [id])
}

model FranchiseLead {
  id                String              @id @default(cuid())
  name              String
  email             String              @unique
  phone             String
  targetCity        String
  region            String              @default("IDF")
  status            FranchiseLeadStatus @default(NEW)
  companyName       String?
  siret             String?
  legalForm         String?
  contractDetails   String              @default("{}")
  contractHistory   String              @default("[]")
  documents         String              @default("[]")
  convertedAgencyId String?             @unique
  rejectionReason   String?

  // === LOI DOUBIN — Art. L330-3 & R330-1 ===
  dipSentAt           DateTime?           // Date d'envoi du DIP (Document d'Information Précontractuelle)
  // Conditions financières (Art. R330-1, 3°)
  entryFee            Int?                // Droit d'entrée (en centimes €)
  royaltyRate         Float?              // Redevance périodique (%)
  advertisingFee      Float?              // Contribution fonds publicité (%)
  // Durée & Résiliation (Art. R330-1, 4° et 6°)
  contractDuration    Int?                // Durée en mois (null = indéterminée)
  renewalTerms        String?             // Conditions de renouvellement (texte libre)
  terminationNotice   Int?                // Préavis de résiliation en mois
  nonCompeteDuration  Int?                // Clause de non-concurrence post-contrat en mois
  // Exclusivité territoriale (Art. R330-1, 5°)
  exclusiveTerritory  Boolean             @default(false)
  exclusiveRadius     Int?                // Rayon d'exclusivité en km

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  convertedAgency   Agency?             @relation(fields: [convertedAgencyId], references: [id])
  notes             FranchiseLeadNote[]
}

model FranchiseLeadNote {
  id        String        @id @default(cuid())
  content   String
  type      String        @default("NOTE")
  author    String
  leadId    String
  createdAt DateTime      @default(now())
  lead      FranchiseLead @relation(fields: [leadId], references: [id])
}

model Appointment {
  id                 String            @id @default(cuid())
  start              DateTime
  end                DateTime
  type               AppointmentType
  status             AppointmentStatus @default(SCHEDULED)
  leadId             String?           // Optionnel: peut être un prospect
  leadName           String
  leadEmail          String?
  prospectId         String?           // Lien vers un prospect (quand pas encore lead)
  agencyId           String?
  hostUserId         String?
  meetingLink        String?
  serviceId          String?
  cancellationReason String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  agency             Agency?           @relation(fields: [agencyId], references: [id])
  hostUser           User?             @relation(fields: [hostUserId], references: [id])
  lead               Lead?             @relation(fields: [leadId], references: [id])
  prospect           Prospect?         @relation(fields: [prospectId], references: [id])
}

model AppointmentSlot {
  id           String   @id @default(cuid())
  juristId     String
  start        DateTime
  end          DateTime
  status       String   @default("AVAILABLE") // AVAILABLE, LOCKED, BOOKED
  leadId       String?
  lockedAt     DateTime?
  
  jurist       User     @relation(fields: [juristId], references: [id])
  lead         Lead?    @relation(fields: [leadId], references: [id])
}

model SystemSettings {
  id               String   @id @default("GLOBAL")
  company          String   @default("{}")
  payment          String   @default("{}")
  notifications    String   @default("{}")
  integrations     String   @default("{}")
  storage          String   @default("{}")
  servicePricing   String   @default("{}")   // Prix dynamiques par service { serviceId: { price: number, promoPrice?: number, promoUntil?: string } }
  servicePricingHistory String @default("[]") // Historique des modifications de prix (audit trail)
  legalDocuments   String   @default("{}")   // CGV, contrat de représentation, mentions légales (HTML/Markdown)
  catalogOverrides    String   @default("{}")   // Surcharges du catalogue (enable/disable services, durées custom, etc.)
  documentCatalog     String   @default("{}")   // Catalogue exhaustif des pièces (DOC_CATALOG)
  serviceTemplates    String   @default("{}")   // Association services <-> pièces (SERVICE_TEMPLATES)
  pipelineAutomations String   @default("{}")   // Règles d'automatisation pipeline (relances, escalades, transitions, etc.)
  updatedAt           DateTime @updatedAt
}

model Transaction {
  id            String   @id @default(cuid())
  type          String   @default("PAYMENT")
  amount        Int
  method        String?
  reference     String?
  leadId        String
  invoiceNumber String?
  createdAt     DateTime @default(now())
  lead          Lead     @relation(fields: [leadId], references: [id])
}

model CreditNote {
  id        String   @id @default(cuid())
  number    String   @unique
  amount    Int
  reason    String
  leadId    String
  createdAt DateTime @default(now())
  lead      Lead     @relation(fields: [leadId], references: [id])
}

enum UserRole {
  SUPER_ADMIN
  HQ_ADMIN
  CASE_WORKER
  AGENCY_MANAGER
  SALES
  KIOSK_AGENT
  API_PARTNER
}

enum AgencyType {
  OWNED
  FRANCHISE
  CORNER
  HQ
  PHYSICAL
}

enum AgencyStatus {
  ACTIVE
  INACTIVE
}

enum LeadStatus {
  NEW
  COLLECTING
  REVIEW
  HUNTING
  BOOKED
  ANTS_SUBMISSION
  WAITING_ORIGINAL
  DRAFTING
  SUBMITTED
  OFII_INVESTIGATION
  DECISION_WAIT
  INSTRUCTION
  TO_CONTACT
  QUALIFIED
  SCHEDULING
  DONE
  ARCHIVED
  CLOSED
  LEAD
  CONTACTED
  SIGNED
  PAID
  PROCESSING
  COMPLETED
  CANCELLED
}

enum ProspectStatus {
  NEW
  CONTACTED
  QUALIFIED
  MEETING_BOOKED
  SIGNED
  NO_SHOW
  LOST
}

enum FranchiseLeadStatus {
  NEW
  CONTACTED
  MEETING
  VALIDATED
  DIP_SENT        // Loi Doubin: DIP envoyé, délai 20 jours commence
  CONTRACT_SENT
  SIGNED
  REJECTED
}

enum AppointmentType {
  VISIO_JURISTE
  PHYSICAL_AGENCY
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Communication {
  id             String   @id @default(cuid())
  direction      String   // INBOUND or OUTBOUND
  type           String   @default("WHATSAPP") // WHATSAPP, SMS, EMAIL
  content        String
  sender         String   // Phone number or User ID or "SYSTEM"
  senderName     String?
  mediaUrl       String?  // URL locale ou distante du fichier reçu
  mediaType      String?  // MIME type: image/jpeg, application/pdf, etc.
  mediaFilename  String?  // Nom du fichier original
  leadId         String?
  prospectId     String?
  createdAt      DateTime @default(now())
  
  lead           Lead?     @relation(fields: [leadId], references: [id])
  prospect       Prospect? @relation(fields: [prospectId], references: [id])
}

// ─── Veille Juridique ──────────────────────────────────────────────

model LegalUpdate {
  id             String   @id @default(cuid())
  title          String
  summary        String
  category       String
  severity       String   @default("medium") // high | medium | low
  sourceUrl      String?
  authorName     String?
  applied        Boolean  @default(false)
  appliedAt      DateTime?
  linkedRuleIds  String   @default("[]") // JSON array of rule IDs impacted by this update
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// ─── Audit Trail des Règles ────────────────────────────────────────

model RuleAuditLog {
  id             String   @id @default(cuid())
  category       String   // sejour | naturalisation | family
  ruleId         String   // id de la règle modifiée
  ruleName       String   // nom lisible de la règle
  action         String   // CREATE | UPDATE | DELETE
  changedBy      String   // nom ou email du juriste
  previousValue  String?  // JSON snapshot avant modification
  newValue       String?  // JSON snapshot après modification  
  changeDetails  String?  // description textuelle du changement
  createdAt      DateTime @default(now())
}

// ─── Veille Légale → Blog Auto-Génération ─────────────────────────

model BlogAutoTopic {
  id             String   @id @default(cuid())
  title          String
  summary        String   // Topic description / why it's relevant
  sourceUrl      String?  // Where it was found
  sourceName     String?  // e.g. "Legifrance", "service-public.fr"
  category       String   @default("GENERAL")
  relevanceScore Int      @default(50) // 0-100: how relevant to SimuLegal's audience
  keywords       String?  // comma-separated keywords
  status         String   @default("DISCOVERED") // DISCOVERED, GENERATING, GENERATED, REJECTED, PUBLISHED
  generatedArticleId String? // ID of generated Article (if any)
  legalUpdateId  String?  // Link to LegalUpdate (if originated from veille)
  error          String?  // Error message if generation fails
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model BlogAutoConfig {
  id               String   @id @default(cuid())
  enabled          Boolean  @default(true)
  frequency        String   @default("WEEKLY") // DAILY, WEEKLY, BIWEEKLY, MONTHLY
  maxArticlesPerRun Int     @default(2)
  minRelevanceScore Int     @default(60) // Min score to auto-generate
  targetCategories String   @default("IMMIGRATION,NATURALISATION,SEJOUR,PERMIS,FAMILY")
  aiModel          String   @default("gpt-4o-mini")
  aiPromptTemplate String?  // Custom prompt template
  lastRunAt        DateTime?
  totalGenerated   Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ─── Blog / Insights ──────────────────────────────────────────────

model Article {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  excerpt         String?
  content         String
  category        String   @default("GENERAL")
  status          String   @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED, SCHEDULED
  coverImage      String?
  authorName      String   @default("Rédaction SimuLegal")
  authorRole      String?
  tags            String?
  metaTitle       String?
  metaDescription String?
  readTimeMin     Int      @default(5)
  viewCount       Int      @default(0)
  featured        Boolean  @default(false)
  scheduledAt     DateTime? // Auto-publish at this date
  publishedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  comments        ArticleComment[]
  revisions       ArticleRevision[]
  reactions       ArticleReaction[]
  analytics       ArticleAnalytics[]
}

model ArticleComment {
  id          String           @id @default(cuid())
  articleId   String
  article     Article          @relation(fields: [articleId], references: [id], onDelete: Cascade)
  authorName  String
  authorEmail String?
  content     String
  status      String           @default("PENDING")
  parentId    String?
  parent      ArticleComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     ArticleComment[] @relation("CommentReplies")
  createdAt   DateTime         @default(now())
}

model ArticleRevision {
  id        String   @id @default(cuid())
  articleId String
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  title     String
  content   String
  excerpt   String?
  editedBy  String?  // Who made the edit
  version   Int      @default(1)
  createdAt DateTime @default(now())
}

model ArticleReaction {
  id        String   @id @default(cuid())
  articleId String
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  type      String   // LIKE, LOVE, FIRE, USEFUL
  ipHash    String   // Hashed IP to prevent duplicates
  createdAt DateTime @default(now())

  @@unique([articleId, ipHash, type])
}

model ArticleAnalytics {
  id        String   @id @default(cuid())
  articleId String
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  date      DateTime
  views     Int      @default(0)
  uniqueIps Int      @default(0)
  avgTimeMs Int?     // Avg reading time in ms
  referrer  String?  // Top referrer for this day

  @@unique([articleId, date])
}

model NewsletterSubscriber {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  status        String    @default("ACTIVE") // ACTIVE, UNSUBSCRIBED
  subscribedAt  DateTime  @default(now())
  unsubscribedAt DateTime?
  confirmToken  String?   @unique
  confirmed     Boolean   @default(false)
}

model BlogCategory {
  id       String   @id @default(cuid())
  name     String   @unique
  slug     String   @unique
  icon     String?  // Emoji or icon name
  color    String?  // CSS color
  sortOrder Int     @default(0)
  createdAt DateTime @default(now())
}

// ══════════════════════════════════════════════════
// MODULE SUIVI COMMERCIAL
// ══════════════════════════════════════════════════

// Objectifs commerciaux par utilisateur (mensuels/trimestriels)
model SalesObjective {
  id             String   @id @default(cuid())
  userId         String                       // Commercial concerné
  agencyId       String?                      // Optionnel — filtre par agence
  period         String                       // Ex: "2026-02", "2026-Q1"
  periodType     String   @default("MONTHLY") // MONTHLY, QUARTERLY, YEARLY
  metric         String                       // CALLS, MEETINGS_BOOKED, CONVERSIONS, REVENUE, QUALIFIED
  targetValue    Int                          // Objectif cible
  currentValue   Int      @default(0)         // Valeur actuelle (recalculée)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([userId, period, metric])
}

// Journal d'activité commerciale quotidien
model SalesActivity {
  id             String   @id @default(cuid())
  userId         String                       // Commercial
  agencyId       String?
  date           DateTime @default(now())     // Jour de l'activité
  activityType   String                       // CALL, EMAIL, WHATSAPP, MEETING, NOTE, FOLLOW_UP, QUALIFICATION, CONVERSION
  prospectId     String?                      // Prospect lié (optionnel)
  prospectName   String?                      // Snapshot du nom pour historique
  outcome        String?                      // Résultat (INTERESTED, CALLBACK, NO_ANSWER, etc.)
  duration       Int?                         // Durée en secondes (pour appels)
  notes          String?                      // Notes libres
  metadata       Json?                        // Données additionnelles (JSON)
  createdAt      DateTime @default(now())
}

// Commissions individuelles par commercial
model SalesCommission {
  id             String   @id @default(cuid())
  userId         String                       // Commercial bénéficiaire
  agencyId       String?
  prospectId     String?                      // Prospect à l'origine
  prospectName   String?                      // Snapshot nom
  serviceId      String?                      // Service vendu
  serviceName    String?                      // Snapshot nom du service
  amountEuros    Float                        // Montant de la commission
  rate           Float                        // Taux appliqué (ex: 5%)
  baseAmount     Float                        // Montant de base (prix du service)
  status         String   @default("PENDING") // PENDING, APPROVED, PAID, CANCELLED
  paidAt         DateTime?                    // Date de versement
  period         String?                      // Période de rattachement (ex: "2026-02")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
